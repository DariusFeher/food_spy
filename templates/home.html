{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load materializecss %}
{% block title %}Home{% endblock title %}
{% block content %}

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Compiled and minified CSS -->

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>

    <!-- <script src="{% static 'recipe_list.js' %}"></script> -->
    <link rel="stylesheet" href="{% static 'recipe_prices_results.css' %}">
    <script>
          function showInfoMessage(msg) {
            M.toast({html: '<h5><i class="small material-icons" style="vertical-align: middle;">report_problem</i>  ' + msg + '</h5>', classes: 'orange', displayLength: '4000'});
        };
    </script>
    
</head>
<body style="text-align: center;">
    {% if infoMessage %}
        <script>
            showInfoMessage("{{infoMessage}}");
        </script>
    {% endif %}
    <div class="row" style="margin-top:5%; margin-bottom: 5%;">
        <!-- {{request.session.test}} -->
        <div class="col l2 m2 s0"></div>
        <div class="col l8 m8 s11" style="background-color: #F7ECDE;  border-radius:2%; box-shadow: 4px 8px 4px rgba(0, 0, 0, 0.2);">
            <div id="id_welcome" class="typed_text typeText" style="text-align: center; z-index: 99; text-orientation: mixed; ; cursor: default; -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;">
            </div>
            <div class="myriad compare_text">
                Compare your recipe's price at <strong>Tesco</strong> vs <strong>AmazonFresh</strong>!
             </div>
             <div id="myDIV" class="header" style="margin-left: 5%; margin-right: 5%; border-top-right-radius: 5px; border-top-left-radius: 5px;">
                <h2 class="my_recipe_title">My Recipe</h2>
                <input class="myriad ingredient-input" type="text" id="myInput" placeholder="Enter your recipe's ingredients..." style="width: 80%;">
                <a class="addBtn btn-floating btn-small waves-effect waves-light green" onclick="newElement()" style="margin-left: 5%;"><i class="material-icons">add</i></a>
            </div>
            <form  action="{% url 'get_recipe_ingredients_prices' %}" method="POST" style="margin-left: 5%; margin-right: 5%;">
                {% csrf_token %}
                <ul class="ingredients_list" id="myUL">
                    {% for ingredient in request.session.ingredients %}
                        <li class="ingredient_item">{{ingredient}}<span class="close">Ã—</span><input class="ingredients" type="hidden" name="ingredients" value="{{ingredient}}"></li>
                    {% endfor %}
                </ul>
                <div style="margin: auto; text-align: center;">
                    <button class="btn waves-effect waves-light" type="submit" name="action" style="margin-top: 3%; background-color: #54bab9 !important;" >Get Prices
                        <i class="material-icons right">send</i>
                    </button>
                </div>
            </form>
        </div>
        <div class="col l2 m2 s1"></div>
    </div>
    {% if tesco_products and amazon_products %}
    <div class="row">
        <div class="col l0 s1"></div>
        <div class="col l12 m10 s10">
            <div class="row" style="margin-bottom: 3%; text-align: center; align-items: center;">
                <div class="col m0 l1 s1">
                </div>
                <div class="col l5 m12 s12">
                    <ul class="collection">
                        <li style="background-color: white; text-align: center; padding-bottom: 5%; padding-top: 5%;">
                            <img class="img-fluid" src="{% static 'Tesco_logo.png' %}" alt="tesco_logo" style=" width: 50%; vertical-align: middle;">
                        </li>
                        {% for ingredient, products in tesco_products.items %}
                            <li class="collection-item avatar ingredient_item" style="text-align: left;">
                                <i class="material-icons circle">restaurant_menu</i>
                                <span class="title" style="margin-bottom: 5%;"><strong>{{ingredient}}</strong></span>
                                <ul class="ingredients_list" id="myUL">
                                    {% for product in products %}
                                    <li class="ingredient_item myriad" style="margin-top: 5%; padding-left: 5%; margin-left: 0%;">
                                        <div class="row" style="margin: 0%; padding: 0%;">
                                            <div class="col s10" style="margin: 0%; padding: 0%;"> <a class="product_link" href="{{product.link}}" target="_blank" style="text-align: left; margin-right: 1%;">{{product.full_name}}  <i class="tiny material-icons" style="vertical-align: middle;">open_in_new</i></a> </div>
                                            <div class="col s2" style="margin: 0%; padding: 0%;"> <strong style="float: right; font-weight: bold;">{{product.price}}{{product.currency}}</strong>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="col l5 m12 s12" style="text-align: center; align-items: center;">
                    <ul class="collection">
                        <li style="background-color: white; text-align: center; padding-bottom: 5%; padding-top: 5%;">
                            <img class="img-fluid" src="{% static 'Amazon_Fresh_logo.png' %}" alt="amazon_logo" style=" width: 50%; vertical-align: middle;">
                        </li>
                        {% for ingredient, products in amazon_products.items %}
                            <li class="collection-item avatar ingredient_item" style="text-align: left;">
                                <i class="material-icons circle">restaurant_menu</i>
                                <span class="title" style="margin-bottom: 5%;"><strong>{{ingredient}}</strong></span>
                                <ul class="ingredients_list" id="myUL">
                                    {% for product in products %}
                                    <li class="ingredient_item myriad" style="margin-top: 5%; padding-left: 5%; margin-left: 0%;">
                                        <div class="row" style="margin: 0%; padding: 0%;">
                                            <div class="col s10"><a class="product_link" href="{{product.link}}" target="_blank" style="text-align: left; margin-right: 1%;">{{product.full_name}}  <i class="tiny material-icons" style="vertical-align: middle;">open_in_new</i></a> </div>
                                            <div class="col s2"><strong style="float: right; font-weight: bold;">{{product.price}}{{product.currency}}</strong>
                                            </div>
                                        </div>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                        {% endfor %}
                    </ul>
                    
                </div>
                <div class="col m0 l1 s1"></div>
            </div>
        </div>
        <div class="col s1"></div>
    </div>
    <div style="text-align: center; margin-top: 0%;">
        <form action="/myrecipes/" method="POST">
            {% csrf_token %}
            <input type="hidden" name="hidden_inp" value="hidden">
            <button class="btn-large waves-effect waves-light" type="submit" name="action" style="background-color: #54bab9 !important;" >Save Recipe and Prices
                <i class="material-icons right">save</i>
            </button>
        </form>
    </div>
    {% endif %}
</body>
<script>
      
// Click on a close button to hide the current list item
var close = document.getElementsByClassName("close");
var ingredients_list = document.getElementsByClassName("ingredients");
var i;
for (i = 0; i < close.length; i++) {
  close[i].onclick = function() {
    console.log(this.className);
    var div = this.parentElement;
    div.style.display = "none";
    $(this).parent().remove();
  }
}

// Add a "checked" symbol when clicking on a list item
var list = document.querySelector('ul');
list.addEventListener('click', function(ev) {
  if (ev.target.tagName === 'LI') {
    ev.target.classList.toggle('checked');
  }
}, false);

// Create a new list item when clicking on the "Add" button
function newElement() {
  var li = document.createElement("li");
  li.classList.add('ingredient_item');
  var inputValue = document.getElementById("myInput").value;
  var t = document.createTextNode(inputValue);
  li.appendChild(t);
  if (inputValue === '') {
    alert("You must write an ingredient!");
  } else {
    document.getElementById("myUL").appendChild(li);
  }
  document.getElementById("myInput").value = "";

  var span = document.createElement("SPAN");
  var txt = document.createTextNode("\u00D7");
  var input_to_be_submitted = document.createElement("input");
  input_to_be_submitted.setAttribute("type", "hidden");
  input_to_be_submitted.setAttribute("class", "ingredients");
  input_to_be_submitted.setAttribute("name", "ingredients");
  input_to_be_submitted.setAttribute("value", inputValue);
  span.className = "close";
  span.appendChild(txt);
  li.appendChild(span);
  console.log("here");
  li.appendChild(input_to_be_submitted);

  for (i = 0; i < close.length; i++) {
    close[i].onclick = function() {
      var div = this.parentElement;
      div.style.display = "none";
      $(this).parent().remove();
    }
  }
}
// -------------------------------



// var myNodelist = document.getElementsByTagName("LI");
// var i;
// for (i = 0; i < myNodelist.length; i++) {
//   var span = document.createElement("SPAN");
//   var txt = document.createTextNode("\u00D7");
//   span.className = "close";
//   span.appendChild(txt);
//   myNodelist[i].appendChild(span);
// }

var typeText = document.querySelector("#id_welcome")
var textToBeTyped = "Welcome to foodSpy!"
var index = 0, isAdding = true

function sleep(ms) {
return new Promise(resolve => setTimeout(resolve, ms));
}

async function playAnim() {
setTimeout(function () {
    // set the text of typeText to a substring of the text to be typed using index.
    typeText.innerText = textToBeTyped.slice(0, index)
    if (isAdding) {
    // adding text
    if (index > textToBeTyped.length) {
        // no more text to add
        isAdding = false
        //break: wait 2s before playing again
        setTimeout(function () {
        playAnim()
        }, 2000)
        return
    } else {
        // increment index by 1
        index++
    }
    }

    playAnim()
}, 120)
if (index == textToBeTyped.length) {
    console.log("DONE");
    await sleep(500);
    $("#id_welcome").attr('class', 'typed_text');
}
}
// start animation
playAnim()

$("#submitIngredientsForm").click(function() {

    var url = "get_prices/"; // the script where you handle the form input.
    if (document.getElementById('myUL').getElementsByTagName('li').length >= 1) {
        var request = $.ajax({
        type: "POST",
        url: url,
        data: $("#ingredientsForm").serialize(), // serializes the form's elements.
        // success: function(data)
        // {
        //     // alert(data); // show response from the php script.
        // }
        });
    } else {
        alert("Please enter at least an ingredient!")
    }

    return false; // avoid to execute the actual submit of the form.
    });


</script>
{% endblock content %}